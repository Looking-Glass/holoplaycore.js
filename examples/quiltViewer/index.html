<html>

	<head>
                <script src="../../dist/holoplaycore.js"></script>
		<script type="text/javascript">
			let client = new HoloPlayCore.Client();
			var curQuiltOptions = 
			{
				q : null,
				vx : null,
				vy : null,
				vt : null,
				a : null,
				ov : null
			}
			function populate() {
				var urlParams = new URLSearchParams(window.location.search);
				for (let key in curQuiltOptions)
				{
					val = urlParams.get(key);
					if (val != null) document.getElementById(key).value = val;
				}
			}
			function downloadFromURL(url, responseType, callback){
				var xhttp = new XMLHttpRequest();
				xhttp.responseType = responseType;
				xhttp.onreadystatechange = function() {
					if (this.readyState == 4) {
						if (this.status == 200) {
							callback(this.response);
						}
					} 
				};
				xhttp.open("GET", url, true);
				xhttp.send();
			}
			function sanitize(input_id) {
				field = document.getElementById(input_id);
				input = field.value;
				if (input == null || input == '') return null;
				if (field.className == "float") {return (isNaN(input) ? null : (parseFloat(input)))}
				else if (field.className == "int") {return (isNaN(input) ? null : (parseInt(input)))}
				return input.trim();
			}
			function populateEntry(key)
			{
				curQuiltOptions[key] = sanitize(key);
				document.getElementById(key).value = curQuiltOptions[key];
			}
			function arrayBufferDone(buf)
			{
				s = {};
				if (curQuiltOptions.vx != null) s.vx = curQuiltOptions.vx;
				if (curQuiltOptions.vy != null) s.vy = curQuiltOptions.vy;
				if (curQuiltOptions.vt != null) s.vtotal = curQuiltOptions.vt;
				if (curQuiltOptions.a != null) s.aspect = curQuiltOptions.a;
				if (curQuiltOptions.ov != null) s.ov = curQuiltOptions.ov;
				console.log(s);
				let showCmd = new HoloPlayCore.ShowMessage(settings=s, bindata=new Uint8Array(buf));
				client.sendMessage(showCmd).then(
					function() { 
						console.log("Quilt displayed");
					}).catch(function(err) {
						console.log(err);
					}
				);
			}
			function imageLoaded(img)
			{
				// img is a blob
				if (img == null) return;
				var myReader = new FileReader();
				var urlCreator = window.URL || window.webkitURL;
				var imageUrl = urlCreator.createObjectURL(img);
				document.getElementById("preview_img").src = imageUrl;
				document.getElementById("preview_img").style="display:block;width:300px";
				myReader.onload = function(e){
					arrayBufferDone(e.target.result);
				};
				myReader.readAsArrayBuffer(img);
			}
			function onDropFile(f)
			{
				document.getElementById('q').value = '';
				updateURL('q');
				document.getElementById("urldiv").style="display:none";
				document.getElementById("filediv").style="display:block";
				imageLoaded(f);
			}
			function showquilt()
			{
				if (curQuiltOptions.q != null)
				{
					downloadFromURL(curQuiltOptions.q, "blob", imageLoaded);
				}
			}
			function updateURL(key=null) {
				if (key == null) { for (let key in curQuiltOptions) populateEntry(key); }
				else populateEntry(key);
				myURL = window.location.href.split("?")[0];
				myURL = myURL.replace(/\/$/, '');
				if (curQuiltOptions.q != null && curQuiltOptions.q != '') {
					first = true; 
					for (let key in curQuiltOptions)
					{
						val = curQuiltOptions[key];
						if (val != null) {
							if (!first) myURL+= "&";
							else myURL += "?";
							first = false;
							myURL+=key;
							myURL+="=";
							myURL+=val;
						}
					}
				}
				document.getElementById("share_field").value = myURL;
				window.history.replaceState({}, "", myURL);
			}
			function setup() {
				document.body.addEventListener('drop', (e) => {
					console.log(e.dataTransfer.items[0]);
					onDropFile(e.dataTransfer.items[0].getAsFile());
					e.preventDefault();
				});
				document.body.addEventListener('dragover', (e) => {
					e.preventDefault();
				});
				populate();
				updateURL();
				if (curQuiltOptions.q != '' && curQuiltOptions.q != null) showquilt();
			}
		</script>

		<title>Quilt Viewer</title>
	</head>
	<body onload="setup()">
		<div>
		vx: <input type="text" class="int" onchange="updateURL('vx')" id="vx"><br/>
		vy: <input type="text" class="int" onchange="updateURL('vy')" id="vy"><br/>
		vt: <input type="text" class="int" onchange="updateURL('vt')" id="vt"><br/>
		aspect: <input type="text" class="float" onchange="updateURL('a')" id="a"><br/>
		overscan: <input type="text" class="int" onchange="updateURL('ov')" id="ov"><br/>
		</div>
		<br/>
		<div id="urldiv">
		url: <input type="text" size=100 id="q" onchange="updateURL('q')"><br/>
		share url: <input type="text" size=100 readonly id="share_field"><br/>
		</div>
		<div id="filediv" style="display:none">File uploaded.</div>
		<button onclick="showquilt()">Refresh</button>
		<img id="preview_img" style="display:none"/>
	</body>

</html>
