(function(e,t){typeof exports==="object"&&typeof module!=="undefined"?t(exports):typeof define==="function"&&define.amd?define(["exports"],t):(e=e||self,t(e.HoloPlayCore={}))})(this,(function(e){"use strict";var t=5.960464477539063e-8,n=4294967296,r=9007199254740992;function s(e){var t=new ArrayBuffer(256);var s=new DataView(t);var i;var a=0;function u(e){var n=t.byteLength;var r=a+e;while(n<r)n<<=1;if(n!==t.byteLength){var u=s;t=new ArrayBuffer(n);s=new DataView(t);var o=a+3>>2;for(var l=0;l<o;++l)s.setUint32(l<<2,u.getUint32(l<<2))}i=e;return s}function o(){a+=i}function l(e){o(u(8).setFloat64(a,e))}function f(e){o(u(1).setUint8(a,e))}function c(e){var t=u(e.length);for(var n=0;n<e.length;++n)t.setUint8(a+n,e[n]);o()}function h(e){o(u(2).setUint16(a,e))}function d(e){o(u(4).setUint32(a,e))}function p(e){var t=e%n;var r=(e-t)/n;var s=u(8);s.setUint32(a,r);s.setUint32(a+4,t);o()}function g(e,t){if(t<24){f(e<<5|t)}else if(t<256){f(e<<5|24);f(t)}else if(t<65536){f(e<<5|25);h(t)}else if(t<4294967296){f(e<<5|26);d(t)}else{f(e<<5|27);p(t)}}function w(e){var t;if(e===false)return f(244);if(e===true)return f(245);if(e===null)return f(246);if(e===undefined)return f(247);switch(typeof e){case"number":if(Math.floor(e)===e){if(0<=e&&e<=r)return g(0,e);if(-r<=e&&e<0)return g(1,-(e+1))}f(251);return l(e);case"string":var n=[];for(t=0;t<e.length;++t){var s=e.charCodeAt(t);if(s<128){n.push(s)}else if(s<2048){n.push(192|s>>6);n.push(128|s&63)}else if(s<55296){n.push(224|s>>12);n.push(128|s>>6&63);n.push(128|s&63)}else{s=(s&1023)<<10;s|=e.charCodeAt(++t)&1023;s+=65536;n.push(240|s>>18);n.push(128|s>>12&63);n.push(128|s>>6&63);n.push(128|s&63)}}g(3,n.length);return c(n);default:var i;if(Array.isArray(e)){i=e.length;g(4,i);for(t=0;t<i;++t)w(e[t])}else if(e instanceof Uint8Array){g(2,e.length);c(e)}else{var a=Object.keys(e);i=a.length;g(5,i);for(t=0;t<i;++t){var u=a[t];w(u);w(e[u])}}}}w(e);if("slice"in t)return t.slice(0,a);var v=new ArrayBuffer(a);var y=new DataView(v);for(var b=0;b<a;++b)y.setUint8(b,s.getUint8(b));return v}function i(e,r,s){var i=new DataView(e);var a=0;if(typeof r!=="function")r=function(e){return e};if(typeof s!=="function")s=function(){return undefined};function u(e,t){a+=e;return t}function o(t){return u(t,new Uint8Array(e,a,t))}function l(){var e=new ArrayBuffer(4);var n=new DataView(e);var r=d();var s=r&32768;var i=r&31744;var a=r&1023;if(i===31744)i=255<<10;else if(i!==0)i+=127-15<<10;else if(a!==0)return(s?-1:1)*a*t;n.setUint32(0,s<<16|i<<13|a<<13);return n.getFloat32(0)}function f(){return u(4,i.getFloat32(a))}function c(){return u(8,i.getFloat64(a))}function h(){return u(1,i.getUint8(a))}function d(){return u(2,i.getUint16(a))}function p(){return u(4,i.getUint32(a))}function g(){return p()*n+p()}function w(){if(i.getUint8(a)!==255)return false;a+=1;return true}function v(e){if(e<24)return e;if(e===24)return h();if(e===25)return d();if(e===26)return p();if(e===27)return g();if(e===31)return-1;throw"Invalid length encoding"}function y(e){var t=h();if(t===255)return-1;var n=v(t&31);if(n<0||t>>5!==e)throw"Invalid indefinite length element";return n}function b(e,t){for(var n=0;n<t;++n){var r=h();if(r&128){if(r<224){r=(r&31)<<6|h()&63;t-=1}else if(r<240){r=(r&15)<<12|(h()&63)<<6|h()&63;t-=2}else{r=(r&15)<<18|(h()&63)<<12|(h()&63)<<6|h()&63;t-=3}}if(r<65536){e.push(r)}else{r-=65536;e.push(55296|r>>10);e.push(56320|r&1023)}}}function m(){var e=h();var t=e>>5;var n=e&31;var i;var a;if(t===7){switch(n){case 25:return l();case 26:return f();case 27:return c()}}a=v(n);if(a<0&&(t<2||6<t))throw"Invalid length";switch(t){case 0:return a;case 1:return-1-a;case 2:if(a<0){var u=[];var d=0;while((a=y(t))>=0){d+=a;u.push(o(a))}var p=new Uint8Array(d);var g=0;for(i=0;i<u.length;++i){p.set(u[i],g);g+=u[i].length}return p}return o(a);case 3:var q=[];if(a<0){while((a=y(t))>=0)b(q,a)}else b(q,a);return String.fromCharCode.apply(null,q);case 4:var C;if(a<0){C=[];while(!w())C.push(m())}else{C=new Array(a);for(i=0;i<a;++i)C[i]=m()}return C;case 5:var U={};for(i=0;i<a||a<0&&!w();++i){var M=m();U[M]=m()}return U;case 6:return r(m(),a);case 7:switch(a){case 20:return false;case 21:return true;case 22:return null;case 23:return undefined;default:return s(a)}}}var q=m();if(a!==e.byteLength)throw"Remaining bytes";return q}
/**
   * This files defines the HoloPlayClient class and Message class.
   *
   * Copyright (c) [2019] [Looking Glass Factory]
   *
   * @link    https://lookingglassfactory.com/
   * @file    This files defines the HoloPlayClient class and Message class.
   * @author  Looking Glass Factory.
   * @version 0.0.8
   * @license SEE LICENSE IN LICENSE.md
   */const a=typeof window==="undefined"?require("ws"):window.WebSocket;class u{constructor(e,t,n,r=false,s,i,a){this.reqs=[];this.reps=[];this.requestId=this.getRequestId();this.debug=r;this.isGreedy=i;this.errCallback=t;this.closeCallback=n;this.alwaysdebug=false;this.isConnected=false;let u=null;if(s||i||a){u=new l(s,i,a,this.debug)}else{if(r)this.alwaysdebug=true;if(typeof e=="function")u=new d}this.openWebsocket(u,e)}sendMessage(e,t=60){if(this.alwaysdebug)e.cmd.debug=true;let n=e.toCbor();return this.sendRequestObj(n,t)}disconnect(){this.ws.close()}openWebsocket(e=null,t=null){this.ws=new a("ws://localhost:11222/driver",["rep.sp.nanomsg.org"]);this.ws.parent=this;this.ws.binaryType="arraybuffer";this.ws.onmessage=this.messageHandler;this.ws.onopen=()=>{this.isConnected=true;if(this.debug){console.log("socket open")}if(e!=null){this.sendMessage(e).then(t)}};this.ws.onerror=this.onSocketError;this.ws.onclose=this.onClose}sendRequestObj(e,t){return new Promise((n,r)=>{let s={id:this.requestId++,parent:this,payload:e,success:n,error:r,send:function(){if(this.debug)console.log("attemtping to send request with ID "+this.id);this.timeout=setTimeout(s.send.bind(this),t*1e3);let n=new Uint8Array(e.byteLength+4);let r=new DataView(n.buffer);r.setUint32(0,this.id);n.set(new Uint8Array(this.payload),4);this.parent.ws.send(n.buffer)}};this.reqs.push(s);s.send()})}messageHandler(e){console.log("message");let t=e.data;if(t.byteLength<4)return;let n=new DataView(t);let r=n.getUint32(0);if(r<2147483648){this.parent.err("bad nng header");return}let s=this.parent.findReqIndex(r);if(s==-1){this.parent.err("got reply that doesn't match known request!");return}let a={id:r,payload:i(t.slice(4))};if(a.payload.error==0){this.parent.reqs[s].success(a.payload)}else{this.parent.reqs[s].error(a.payload)}clearTimeout(this.parent.reqs[s].timeout);this.parent.reqs.splice(s,1);this.parent.reps.push(a);if(this.debug){console.log(a.payload)}}getRequestId(){return Math.floor(this.prng()*2147483647)+2147483648}onClose(e){this.parent.isConnected=false;if(this.parent.debug){console.log("socket closed")}if(typeof this.parent.closeCallback=="function")this.parent.closeCallback(e)}onSocketError(e){if(this.parent.debug){console.log(e)}if(typeof this.parent.errCallback=="function"){this.parent.errCallback(e)}}err(e){if(this.debug){console.log("[DRIVER ERROR]"+e)}}findReqIndex(e){let t=0;for(;t<this.reqs.length;t++){if(this.reqs[t].id==e){return t}}return-1}prng(){if(this.rng==undefined){this.rng=b()}return this.rng()}}class o{constructor(e,t){this.cmd=e;this.bin=t}toCbor(){return s(this)}}class l extends o{constructor(e="",t=false,n="",r=false){let s={init:{}};if(e!="")s["init"].appid=e;if(n!="")s["init"].onclose=n;if(t)s["init"].greedy=true;if(r)s["init"].debug=true;super(s,null)}}class f extends o{constructor(e=""){let t={delete:{name:e}};super(t,null)}}class c extends o{constructor(e=""){let t={check:{name:e}};super(t,null)}}class h extends o{constructor(e=null){let t={wipe:{}};if(e!=null)t["wipe"].targetDisplay=e;super(t,null)}}class d extends o{constructor(){let e={info:{}};super(e,null)}}class p extends o{constructor(){let e={uniforms:{}};super(e,bindata)}}class g extends o{constructor(){let e={shader:{}};super(e,bindata)}}class w extends o{constructor(e={vx:5,vy:9,aspect:1.6},t="",n=null){let r={show:{source:"bindata",quilt:{type:"image",settings:e}}};if(n!=null)r["show"]["targetDisplay"]=n;super(r,t)}}class v extends o{constructor(e,t={vx:5,vy:9,aspect:1.6},n="",r=false){let s={cache:{show:r,quilt:{name:e,type:"image",settings:t}}};super(s,n)}}class y extends o{constructor(e,t=null,n=null){let r={show:{source:"cache",quilt:{name:e}}};if(t!=null)r["show"]["targetDisplay"]=t;if(n!=null)r["show"]["quilt"].settings=n;super(r,null)}}function b(){function e(e){for(var t=0,n=1779033703^e.length;t<e.length;t++)n=Math.imul(n^e.charCodeAt(t),3432918353),n=n<<13|n>>>19;return function(){n=Math.imul(n^n>>>16,2246822507);n=Math.imul(n^n>>>13,3266489909);return(n^=n>>>16)>>>0}}function t(e,t,n,r){return()=>{var s=t<<9,i=e*5;i=(i<<7|i>>>25)*9;n^=e;r^=t;t^=n;e^=r;n^=s;r=r<<11|r>>>21;return(i>>>0)/4294967296}}var n=Date.now();var r=e(n.toString());return t(r(),r(),r(),r())}e.CacheMessage=v;e.CheckMessage=c;e.Client=u;e.DeleteMessage=f;e.InfoMessage=d;e.InitMessage=l;e.Message=o;e.ShaderMessage=g;e.ShowCachedMessage=y;e.ShowMessage=w;e.UniformsMessage=p;e.WipeMessage=h;Object.defineProperty(e,"__esModule",{value:true})}));