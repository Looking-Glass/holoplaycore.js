(function(e,t){typeof exports==="object"&&typeof module!=="undefined"?t(exports):typeof define==="function"&&define.amd?define(["exports"],t):(e=e||self,t(e.HoloPlayCore={}))})(this,(function(e){"use strict";var t=typeof globalThis!=="undefined"?globalThis:typeof window!=="undefined"?window:typeof global!=="undefined"?global:typeof self!=="undefined"?self:{};function r(e,t){return t={exports:{}},e(t,t.exports),t.exports}var n=r((function(e){(function(t,r){var n=Math.pow(2,-24),i=Math.pow(2,32),s=Math.pow(2,53);function o(e){var t=new ArrayBuffer(256);var n=new DataView(t);var o;var a=0;function u(e){var r=t.byteLength;var i=a+e;while(r<i)r*=2;if(r!==t.byteLength){var s=n;t=new ArrayBuffer(r);n=new DataView(t);var u=a+3>>2;for(var l=0;l<u;++l)n.setUint32(l*4,s.getUint32(l*4))}o=e;return n}function l(){a+=o}function f(e){l(u(8).setFloat64(a,e))}function c(e){l(u(1).setUint8(a,e))}function h(e){var t=u(e.length);for(var r=0;r<e.length;++r)t.setUint8(a+r,e[r]);l()}function d(e){l(u(2).setUint16(a,e))}function p(e){l(u(4).setUint32(a,e))}function v(e){var t=e%i;var r=(e-t)/i;var n=u(8);n.setUint32(a,r);n.setUint32(a+4,t);l()}function g(e,t){if(t<24){c(e<<5|t)}else if(t<256){c(e<<5|24);c(t)}else if(t<65536){c(e<<5|25);d(t)}else if(t<4294967296){c(e<<5|26);p(t)}else{c(e<<5|27);v(t)}}function w(e){var t;if(e===false)return c(244);if(e===true)return c(245);if(e===null)return c(246);if(e===r)return c(247);switch(typeof e){case"number":if(Math.floor(e)===e){if(0<=e&&e<=s)return g(0,e);if(-s<=e&&e<0)return g(1,-(e+1))}c(251);return f(e);case"string":var n=[];for(t=0;t<e.length;++t){var i=e.charCodeAt(t);if(i<128){n.push(i)}else if(i<2048){n.push(192|i>>6);n.push(128|i&63)}else if(i<55296){n.push(224|i>>12);n.push(128|i>>6&63);n.push(128|i&63)}else{i=(i&1023)<<10;i|=e.charCodeAt(++t)&1023;i+=65536;n.push(240|i>>18);n.push(128|i>>12&63);n.push(128|i>>6&63);n.push(128|i&63)}}g(3,n.length);return h(n);default:var o;if(Array.isArray(e)){o=e.length;g(4,o);for(t=0;t<o;++t)w(e[t])}else if(e instanceof Uint8Array){g(2,e.length);h(e)}else{var a=Object.keys(e);o=a.length;g(5,o);for(t=0;t<o;++t){var u=a[t];w(u);w(e[u])}}}}w(e);if("slice"in t)return t.slice(0,a);var y=new ArrayBuffer(a);var b=new DataView(y);for(var m=0;m<a;++m)b.setUint8(m,n.getUint8(m));return y}function a(e,t,s){var o=new DataView(e);var a=0;if(typeof t!=="function")t=function(e){return e};if(typeof s!=="function")s=function(){return r};function u(e,t){a+=t;return e}function l(t){return u(new Uint8Array(e,a,t),t)}function f(){var e=new ArrayBuffer(4);var t=new DataView(e);var r=p();var i=r&32768;var s=r&31744;var o=r&1023;if(s===31744)s=255<<10;else if(s!==0)s+=127-15<<10;else if(o!==0)return o*n;t.setUint32(0,i<<16|s<<13|o<<13);return t.getFloat32(0)}function c(){return u(o.getFloat32(a),4)}function h(){return u(o.getFloat64(a),8)}function d(){return u(o.getUint8(a),1)}function p(){return u(o.getUint16(a),2)}function v(){return u(o.getUint32(a),4)}function g(){return v()*i+v()}function w(){if(o.getUint8(a)!==255)return false;a+=1;return true}function y(e){if(e<24)return e;if(e===24)return d();if(e===25)return p();if(e===26)return v();if(e===27)return g();if(e===31)return-1;throw"Invalid length encoding"}function b(e){var t=d();if(t===255)return-1;var r=y(t&31);if(r<0||t>>5!==e)throw"Invalid indefinite length element";return r}function m(e,t){for(var r=0;r<t;++r){var n=d();if(n&128){if(n<224){n=(n&31)<<6|d()&63;t-=1}else if(n<240){n=(n&15)<<12|(d()&63)<<6|d()&63;t-=2}else{n=(n&15)<<18|(d()&63)<<12|(d()&63)<<6|d()&63;t-=3}}if(n<65536){e.push(n)}else{n-=65536;e.push(55296|n>>10);e.push(56320|n&1023)}}}function x(){var e=d();var n=e>>5;var i=e&31;var o;var a;if(n===7){switch(i){case 25:return f();case 26:return c();case 27:return h()}}a=y(i);if(a<0&&(n<2||6<n))throw"Invalid length";switch(n){case 0:return a;case 1:return-1-a;case 2:if(a<0){var u=[];var p=0;while((a=b(n))>=0){p+=a;u.push(l(a))}var v=new Uint8Array(p);var g=0;for(o=0;o<u.length;++o){v.set(u[o],g);g+=u[o].length}return v}return l(a);case 3:var q=[];if(a<0){while((a=b(n))>=0)m(q,a)}else m(q,a);return String.fromCharCode.apply(null,q);case 4:var C;if(a<0){C=[];while(!w())C.push(x())}else{C=new Array(a);for(o=0;o<a;++o)C[o]=x()}return C;case 5:var U={};for(o=0;o<a||a<0&&!w();++o){var M=x();U[M]=x()}return U;case 6:return t(x(),a);case 7:switch(a){case 20:return false;case 21:return true;case 22:return null;case 23:return r;default:return s(a)}}}var q=x();if(a!==e.byteLength)throw"Remaining bytes";return q}var u={encode:o,decode:a};if(typeof r==="function"&&r.amd)r("cbor/cbor",u);else if(e.exports)e.exports=u;else if(!t.CBOR)t.CBOR=u})(t)}));
/**
	 * This files defines the HoloPlayClient class and Message class.
	 *
	 * Copyright (c) [2019] [Looking Glass Factory]
	 *
	 * @link    https://lookingglassfactory.com/
	 * @file    This files defines the HoloPlayClient class and Message class.
	 * @author  Looking Glass Factory.
	 * @version 0.0.8
	 * @license SEE LICENSE IN LICENSE.md
	 */const i=typeof window==="undefined"?require("ws"):window.WebSocket;class s{constructor(e,t,r,n=false,i,s,o){this.reqs=[];this.reps=[];this.requestId=this.getRequestId();this.debug=n;this.isGreedy=s;this.errCallback=t;this.closeCallback=r;this.alwaysdebug=false;this.isConnected=false;let u=null;if(i||s||o){u=new a(i,s,o,this.debug)}else{if(n)this.alwaysdebug=true;if(typeof e=="function")u=new c}this.openWebsocket(u,e)}sendMessage(e,t=60){if(this.alwaysdebug)e.cmd.debug=true;let r=e.toCbor();return this.sendRequestObj(r,t)}disconnect(){this.ws.close()}openWebsocket(e=null,t=null){this.ws=new i("ws://localhost:11222/driver",["rep.sp.nanomsg.org"]);this.ws.parent=this;this.ws.binaryType="arraybuffer";this.ws.onmessage=this.messageHandler;this.ws.onopen=()=>{this.isConnected=true;if(this.debug){console.log("socket open")}if(e!=null){this.sendMessage(e).then(t)}};this.ws.onerror=this.onSocketError;this.ws.onclose=this.onClose}sendRequestObj(e,t){return new Promise((r,n)=>{let i={id:this.requestId++,parent:this,payload:e,success:r,error:n,send:function(){if(this.debug)console.log("attemtping to send request with ID "+this.id);this.timeout=setTimeout(i.send.bind(this),t*1e3);let r=new Uint8Array(e.byteLength+4);let n=new DataView(r.buffer);n.setUint32(0,this.id);r.set(new Uint8Array(this.payload),4);this.parent.ws.send(r.buffer)}};this.reqs.push(i);i.send()})}messageHandler(e){console.log("message");let t=e.data;if(t.byteLength<4)return;let r=new DataView(t);let i=r.getUint32(0);if(i<2147483648){this.parent.err("bad nng header");return}let s=this.parent.findReqIndex(i);if(s==-1){this.parent.err("got reply that doesn't match known request!");return}let o={id:i,payload:n.decode(t.slice(4))};if(o.payload.error==0){this.parent.reqs[s].success(o.payload)}else{this.parent.reqs[s].error(o.payload)}clearTimeout(this.parent.reqs[s].timeout);this.parent.reqs.splice(s,1);this.parent.reps.push(o);if(this.debug){console.log(o.payload)}}getRequestId(){return Math.floor(this.prng()*2147483647)+2147483648}onClose(e){this.parent.isConnected=false;if(this.parent.debug){console.log("socket closed")}if(typeof this.parent.closeCallback=="function")this.parent.closeCallback(e)}onSocketError(e){if(this.parent.debug){console.log(e)}if(typeof this.parent.errCallback=="function"){this.parent.errCallback(e)}}err(e){if(this.debug){console.log("[DRIVER ERROR]"+e)}}findReqIndex(e){let t=0;for(;t<this.reqs.length;t++){if(this.reqs[t].id==e){return t}}return-1}prng(){if(this.rng==undefined){this.rng=w()}return this.rng()}}class o{constructor(e,t){this.cmd=e;this.bin=t}toCbor(){return n.encode(this)}}class a extends o{constructor(e="",t=false,r="",n=false){let i={init:{}};if(e!="")i["init"].appid=e;if(r!="")i["init"].onclose=r;if(t)i["init"].greedy=true;if(n)i["init"].debug=true;super(i,null)}}class u extends o{constructor(e=""){let t={delete:{name:e}};super(t,null)}}class l extends o{constructor(e=""){let t={check:{name:e}};super(t,null)}}class f extends o{constructor(e=null){let t={wipe:{}};if(e!=null)t["wipe"].targetDisplay=e;super(t,null)}}class c extends o{constructor(){let e={info:{}};super(e,null)}}class h extends o{constructor(){let e={uniforms:{}};super(e,bindata)}}class d extends o{constructor(){let e={shader:{}};super(e,bindata)}}class p extends o{constructor(e={vx:5,vy:9,aspect:1.6},t="",r=null){let n={show:{source:"bindata",quilt:{type:"image",settings:e}}};if(r!=null)n["show"]["targetDisplay"]=r;super(n,t)}}class v extends o{constructor(e,t={vx:5,vy:9,aspect:1.6},r="",n=false){let i={cache:{show:n,quilt:{name:e,type:"image",settings:t}}};super(i,r)}}class g extends o{constructor(e,t=null,r=null){let n={show:{source:"cache",quilt:{name:e}}};if(t!=null)n["show"]["targetDisplay"]=t;if(r!=null)n["show"]["quilt"].settings=r;super(n,null)}}function w(){function e(e){for(var t=0,r=1779033703^e.length;t<e.length;t++)r=Math.imul(r^e.charCodeAt(t),3432918353),r=r<<13|r>>>19;return function(){r=Math.imul(r^r>>>16,2246822507);r=Math.imul(r^r>>>13,3266489909);return(r^=r>>>16)>>>0}}function t(e,t,r,n){return()=>{var i=t<<9,s=e*5;s=(s<<7|s>>>25)*9;r^=e;n^=t;t^=r;e^=n;r^=i;n=n<<11|n>>>21;return(s>>>0)/4294967296}}var r=Date.now();var n=e(r.toString());return t(n(),n(),n(),n())}function y(e,...t){let r=e[0];for(let n=1;n<e.length;++n){const i=t[n-1];r+=typeof i==="number"?i.toPrecision(10):i;r+=e[n]}return r}function b(e){return y`
  precision mediump float;
  uniform int u_viewType;
  uniform sampler2D u_texture;
  varying vec2 v_texcoord;
  const float pitch    = ${e.pitch};
  const float tilt     = ${e.tilt};
  const float center   = ${e.calibration.center.value};
  const float invView  = ${e.calibration.invView.value};
  const float flipX    = ${e.calibration.flipImageX.value};
  const float flipY    = ${e.calibration.flipImageY.value};
  const float subp     = ${e.subp};
  const float numViews = ${e.numViews};
  const float tilesX   = ${e.quiltWidth};
  const float tilesY   = ${e.quiltHeight};
  const vec2 quiltViewPortion = vec2(
    ${e.quiltWidth*e.tileWidth/e.framebufferWidth},
    ${e.quiltHeight*e.tileHeight/e.framebufferHeight});
  vec2 texArr(vec3 uvz) {
    float z = floor(uvz.z * numViews);
    float x = (mod(z, tilesX) + uvz.x) / tilesX;
    float y = (floor(z / tilesX) + uvz.y) / tilesY;
    return vec2(x, y) * quiltViewPortion;
  }
  float remap(float value, float from1, float to1, float from2, float to2) {
    return (value - from1) / (to1 - from1) * (to2 - from2) + from2;
  }
  void main() {
    if (u_viewType == 2) { // "quilt" view
      gl_FragColor = texture2D(u_texture, v_texcoord);
      return;
    }
    if (u_viewType == 1) { // middle view
      gl_FragColor = texture2D(u_texture, texArr(vec3(v_texcoord.x, v_texcoord.y, 0.5)));
      return;
    }
    vec4 rgb[3];
    vec3 nuv = vec3(v_texcoord.xy, 0.0);
    // Flip UVs if necessary
    nuv.x = (1.0 - flipX) * nuv.x + flipX * (1.0 - nuv.x);
    nuv.y = (1.0 - flipY) * nuv.y + flipY * (1.0 - nuv.y);
    for (int i = 0; i < 3; i++) {
      nuv.z = (v_texcoord.x + float(i) * subp + v_texcoord.y * tilt) * pitch - center;
      nuv.z = mod(nuv.z + ceil(abs(nuv.z)), 1.0);
      nuv.z = (1.0 - invView) * nuv.z + invView * (1.0 - nuv.z);
      rgb[i] = texture2D(u_texture, texArr(vec3(v_texcoord.x, v_texcoord.y, nuv.z)));
    }
    gl_FragColor = vec4(rgb[0].r, rgb[1].g, rgb[2].b, 1);
  }
`}e.CacheMessage=v;e.CheckMessage=l;e.Client=s;e.DeleteMessage=u;e.InfoMessage=c;e.InitMessage=a;e.Message=o;e.Shader=b;e.ShaderMessage=d;e.ShowCachedMessage=g;e.ShowMessage=p;e.UniformsMessage=h;e.WipeMessage=f;Object.defineProperty(e,"__esModule",{value:true})}));